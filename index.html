<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ask Gurudev Analytics Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-cloud@1.2.5/build/d3.layout.cloud.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .date-picker {
            background: #f8f9fa;
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .date-form {
            display: flex;
            flex-direction: row;
            gap: 30px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .form-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            min-width: 300px;
        }
        
        .date-inputs-group {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .form-group input {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            align-self: center;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            gap: 8px;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .dashboard {
            padding: 30px;
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .stat-card p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .chart-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .section-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            margin: -30px -30px 20px -30px;
            border-radius: 15px 15px 0 0;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .chart-container {
            height: 400px;
            position: relative;
        }
        
        .word-cloud-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .word-cloud-container {
            height: 500px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }
        
        .word-cloud-word {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .word-cloud-word:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        
        .table-section {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table-section h2 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            margin: 0;
            font-size: 1.3rem;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .frequency-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .date-form {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .form-content {
                align-items: center;
                min-width: auto;
                width: 100%;
            }
            .date-inputs-group {
                flex-direction: column;
                gap: 15px;
                align-items: center;
                width: 100%;
            }
            .form-group {
                width: 100%;
                max-width: 300px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Ask Gurudev Analytics Dashboard</h1>
            <p>Insights into Ask Gurudev Usage</p>
        </div>

        <div class="date-picker">
            <form class="date-form" id="dateForm">
                <div class="form-content">
                    <div class="date-inputs-group">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" name="startDate" required />
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" name="endDate" required />
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                <input
                  type="checkbox"
                  id="generateWordCloud"
                  name="generateWordCloud"
                />
                <span class="checkmark"></span>
                Generate Word Cloud
              </label>
                    </div>
                </div>
                <button type="submit" class="submit-btn" id="submitBtn">
            Get Analytics
          </button>
            </form>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Fetching analytics data...</p>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalQuestions">-</h3>
                    <p>Total Questions</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgQuestions">-</h3>
                    <p>Average Questions/Day</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalDays">-</h3>
                    <p>Total Days</p>
                </div>
            </div>

            <div class="chart-section">
                <div class="section-header">
                    <h2>Daily Questions Breakdown</h2>
                </div>
                <div class="chart-container" id="chartContainer"></div>
            </div>

            <div class="word-cloud-section" id="wordCloudSection" style="display: none">
                <div class="section-header">
                    <h2>Word Cloud</h2>
                </div>
                <div class="word-cloud-container" id="wordCloudContainer"></div>
            </div>

            <div class="tables-grid">
                <div class="table-section">
                    <h2>Top Questions</h2>
                    <div class="table-container">
                        <table id="questionsTable">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Frequency</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="table-section">
                    <h2>Top Categories</h2>
                    <div class="table-container">
                        <table id="categoriesTable">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Frequency</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AnalyticsDashboard {
            constructor() {
                this.apiUrl =
                    "https://us-central1-askgurudev-rel-0-1.cloudfunctions.net/askg-stats-function";
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setDefaultDates();
            }

            setupEventListeners() {
                const form = document.getElementById("dateForm");
                form.addEventListener("submit", (e) => this.handleSubmit(e));

                // Add resize listener for responsive chart and word cloud with debounce
                let resizeTimeout;
                let lastWindowWidth = window.innerWidth;
                let lastWindowHeight = window.innerHeight;
                let isScrolling = false;
                let scrollTimeout;

                // Track scroll events to prevent redraws during scrolling
                window.addEventListener(
                    "scroll",
                    () => {
                        isScrolling = true;
                        clearTimeout(scrollTimeout);
                        scrollTimeout = setTimeout(() => {
                            isScrolling = false;
                        }, 150); // Consider scrolling finished after 150ms of no scroll
                    }, {
                        passive: true,
                    }
                );

                // iOS Safari specific: Use visual viewport for more accurate detection
                if (window.visualViewport) {
                    let lastVisualViewportWidth = window.visualViewport.width;
                    let lastVisualViewportHeight = window.visualViewport.height;

                    window.visualViewport.addEventListener("resize", () => {
                        // Don't redraw if currently scrolling
                        if (isScrolling) {
                            return;
                        }

                        const widthDiff = Math.abs(
                            window.visualViewport.width - lastVisualViewportWidth
                        );
                        const heightDiff = Math.abs(
                            window.visualViewport.height - lastVisualViewportHeight
                        );

                        // Require at least 20px change for visual viewport (more sensitive)
                        if (widthDiff > 20 || heightDiff > 20) {
                            lastVisualViewportWidth = window.visualViewport.width;
                            lastVisualViewportHeight = window.visualViewport.height;

                            clearTimeout(resizeTimeout);
                            resizeTimeout = setTimeout(() => {
                                if (this.currentChartData) {
                                    this.createChart(this.currentChartData);
                                }
                                if (this.currentWordCloudData) {
                                    this.createWordCloud(this.currentWordCloudData);
                                }
                            }, 400); // Longer debounce for visual viewport changes
                        }
                    });
                } else {
                    // Fallback for browsers without visual viewport support
                    window.addEventListener("resize", () => {
                        // Don't redraw if currently scrolling
                        if (isScrolling) {
                            return;
                        }

                        // Only redraw if the window dimensions actually changed significantly
                        const widthDiff = Math.abs(window.innerWidth - lastWindowWidth);
                        const heightDiff = Math.abs(
                            window.innerHeight - lastWindowHeight
                        );

                        // Require at least 10px change to avoid minor mobile viewport adjustments
                        if (widthDiff > 10 || heightDiff > 10) {
                            lastWindowWidth = window.innerWidth;
                            lastWindowHeight = window.innerHeight;

                            clearTimeout(resizeTimeout);
                            resizeTimeout = setTimeout(() => {
                                if (this.currentChartData) {
                                    this.createChart(this.currentChartData);
                                }
                                if (this.currentWordCloudData) {
                                    this.createWordCloud(this.currentWordCloudData);
                                }
                            }, 300); // Increased debounce for mobile
                        }
                    });
                }
            }

            setDefaultDates() {
                const today = new Date();
                const twoWeeksAgo = new Date(
                    today.getTime() - 14 * 24 * 60 * 60 * 1000
                );

                document.getElementById("startDate").value =
                    this.formatDate(twoWeeksAgo);
                document.getElementById("endDate").value = this.formatDate(today);
            }

            formatDate(date) {
                return date.toISOString().split("T")[0];
            }

            async handleSubmit(e) {
                e.preventDefault();

                const startDate = document.getElementById("startDate").value;
                const endDate = document.getElementById("endDate").value;

                if (!startDate || !endDate) {
                    this.showError("Please select both start and end dates");
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    this.showError("Start date cannot be after end date");
                    return;
                }

                this.showLoading(true);
                this.hideError();

                try {
                    const data = await this.fetchAnalytics(startDate, endDate);
                    this.displayDashboard(data);
                } catch (error) {
                    this.showError("Failed to fetch analytics data. Please try again.");
                    console.error("Error:", error);
                } finally {
                    this.showLoading(false);
                }
            }

            async fetchAnalytics(startDate, endDate) {
                const generateWordCloud =
                    document.getElementById("generateWordCloud").checked;
                let url = `${this.apiUrl}?start_date=${startDate}&end_date=${endDate}`;

                if (generateWordCloud) {
                    url += "&generate_word_cloud=true";
                }

                console.log("Fetching from URL:", url);

                const response = await fetch(url);
                console.log("Response status:", response.status);
                console.log("Response ok:", response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Response error text:", errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log("API response:", result);

                // Check if the response has the expected structure
                if (result && result.data) {
                    return result.data;
                } else if (result && result.success === false) {
                    throw new Error(
                        result.message || "API returned unsuccessful response"
                    );
                } else {
                    // If the response doesn't have the expected structure, return it as is
                    return result;
                }
            }

            displayDashboard(data) {
                this.updateStats(data);
                this.populateTables(data);
                this.showDashboard();

                // Store current chart data for resize handling
                this.currentChartData = data.daily_analysis.daily_breakdown;

                // Small delay to ensure container is properly sized before creating chart
                setTimeout(() => {
                    this.createChart(this.currentChartData);
                }, 100);

                // Handle word cloud if data is available
                if (data.word_cloud_data && data.word_cloud_data.length > 0) {
                    this.currentWordCloudData = data.word_cloud_data;
                    this.createWordCloud(this.currentWordCloudData);
                    document.getElementById("wordCloudSection").style.display = "block";
                } else {
                    this.currentWordCloudData = null;
                    document.getElementById("wordCloudSection").style.display = "none";
                }
            }

            updateStats(data) {
                document.getElementById("totalQuestions").textContent =
                    data.daily_analysis.total_questions;
                document.getElementById("avgQuestions").textContent =
                    data.daily_analysis.average_daily_questions.toFixed(1);
                document.getElementById("totalDays").textContent =
                    data.date_range.total_days;
            }

            createChart(dailyBreakdown) {
                const container = document.getElementById("chartContainer");
                container.innerHTML = "";

                const dates = Object.keys(dailyBreakdown).sort();
                const values = dates.map((date) => dailyBreakdown[date]);
                const maxValue = Math.max(...values);

                const chartHeight = 350;
                const containerWidth = container.clientWidth || 800;
                const margin = {
                    top: 20,
                    right: 30,
                    bottom: 60,
                    left: 60,
                };
                const chartWidth = containerWidth - margin.left - margin.right;
                const chartHeightInner = chartHeight - margin.top - margin.bottom;

                const svg = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "svg"
                );
                svg.setAttribute("width", containerWidth);
                svg.setAttribute("height", chartHeight);
                svg.style.overflow = "visible";

                // Create chart group
                const chartGroup = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "g"
                );
                chartGroup.setAttribute(
                    "transform",
                    `translate(${margin.left}, ${margin.top})`
                );

                // Calculate scales
                const xScale = chartWidth / (dates.length - 1);
                const yScale = chartHeightInner / maxValue;

                // Create Y-axis
                const yAxis = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "line"
                );
                yAxis.setAttribute("x1", 0);
                yAxis.setAttribute("y1", 0);
                yAxis.setAttribute("x2", 0);
                yAxis.setAttribute("y2", chartHeightInner);
                yAxis.setAttribute("stroke", "#e9ecef");
                yAxis.setAttribute("stroke-width", 2);

                // Create X-axis
                const xAxis = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "line"
                );
                xAxis.setAttribute("x1", 0);
                xAxis.setAttribute("y1", chartHeightInner);
                xAxis.setAttribute("x2", chartWidth);
                xAxis.setAttribute("y2", chartHeightInner);
                xAxis.setAttribute("stroke", "#e9ecef");
                xAxis.setAttribute("stroke-width", 2);

                // Add Y-axis ticks and labels
                const yTicks = 5;
                for (let i = 0; i <= yTicks; i++) {
                    const y = chartHeightInner - (i * chartHeightInner) / yTicks;
                    const value = Math.round((i * maxValue) / yTicks);

                    // Tick line
                    const tick = document.createElementNS(
                        "http://www.w3.org/2000/svg",
                        "line"
                    );
                    tick.setAttribute("x1", -5);
                    tick.setAttribute("y1", y);
                    tick.setAttribute("x2", 0);
                    tick.setAttribute("y2", y);
                    tick.setAttribute("stroke", "#e9ecef");
                    tick.setAttribute("stroke-width", 1);

                    // Tick label
                    const tickLabel = document.createElementNS(
                        "http://www.w3.org/2000/svg",
                        "text"
                    );
                    tickLabel.setAttribute("x", -10);
                    tickLabel.setAttribute("y", y + 4);
                    tickLabel.setAttribute("text-anchor", "end");
                    tickLabel.setAttribute("font-size", "12");
                    tickLabel.setAttribute("fill", "#6c757d");
                    tickLabel.textContent = value;

                    chartGroup.appendChild(tick);
                    chartGroup.appendChild(tickLabel);
                }

                // Add Y-axis label
                const yAxisLabel = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "text"
                );
                yAxisLabel.setAttribute("x", -30);
                yAxisLabel.setAttribute("y", chartHeightInner / 2);
                yAxisLabel.setAttribute("text-anchor", "middle");
                yAxisLabel.setAttribute("font-size", "14");
                yAxisLabel.setAttribute("font-weight", "600");
                yAxisLabel.setAttribute("fill", "#495057");
                yAxisLabel.setAttribute(
                    "transform",
                    `rotate(-90, -30, ${chartHeightInner / 2})`
                );
                yAxisLabel.textContent = "Number of Questions";

                // Add X-axis label
                const xAxisLabel = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "text"
                );
                xAxisLabel.setAttribute("x", chartWidth / 2);
                xAxisLabel.setAttribute("y", chartHeightInner + 50);
                xAxisLabel.setAttribute("text-anchor", "middle");
                xAxisLabel.setAttribute("font-size", "14");
                xAxisLabel.setAttribute("font-weight", "600");
                xAxisLabel.setAttribute("fill", "#495057");
                xAxisLabel.textContent = "Date";

                // Add X-axis date labels with smart skipping
                const maxLabels = Math.floor(chartWidth / 80); // Approximate space needed per label
                const skipInterval = Math.max(1, Math.ceil(dates.length / maxLabels));

                dates.forEach((date, index) => {
                    const x = index * xScale;

                    // Only show labels at skip intervals or for the last date
                    if (index % skipInterval === 0 || index === dates.length - 1) {
                        const dateLabel = document.createElementNS(
                            "http://www.w3.org/2000/svg",
                            "text"
                        );
                        dateLabel.setAttribute("x", x);
                        dateLabel.setAttribute("y", chartHeightInner + 20);
                        dateLabel.setAttribute("text-anchor", "middle");
                        dateLabel.setAttribute("font-size", "11");
                        dateLabel.setAttribute("fill", "#6c757d");
                        dateLabel.setAttribute(
                            "transform",
                            `rotate(-45, ${x}, ${chartHeightInner + 20})`
                        );
                        dateLabel.textContent = new Date(date).toLocaleDateString(
                            "en-US", {
                                month: "short",
                                day: "numeric",
                            }
                        );

                        chartGroup.appendChild(dateLabel);
                    }

                    // Add vertical grid lines
                    const gridLine = document.createElementNS(
                        "http://www.w3.org/2000/svg",
                        "line"
                    );
                    gridLine.setAttribute("x1", x);
                    gridLine.setAttribute("y1", 0);
                    gridLine.setAttribute("x2", x);
                    gridLine.setAttribute("y2", chartHeightInner);
                    gridLine.setAttribute("stroke", "#f8f9fa");
                    gridLine.setAttribute("stroke-width", 1);
                    gridLine.setAttribute("stroke-dasharray", "2,2");

                    chartGroup.appendChild(gridLine);
                });

                // Create the line path
                const linePath = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "path"
                );
                let pathData = "M ";

                dates.forEach((date, index) => {
                    const x = index * xScale;
                    const y = chartHeightInner - dailyBreakdown[date] * yScale;
                    pathData += `${x},${y} `;
                });

                linePath.setAttribute("d", pathData);
                linePath.setAttribute("fill", "none");
                linePath.setAttribute("stroke", "url(#lineGradient)");
                linePath.setAttribute("stroke-width", 3);
                linePath.setAttribute("stroke-linecap", "round");
                linePath.setAttribute("stroke-linejoin", "round");

                // Create data points
                dates.forEach((date, index) => {
                    const x = index * xScale;
                    const y = chartHeightInner - dailyBreakdown[date] * yScale;
                    const value = dailyBreakdown[date];

                    // Create circle for data point
                    const circle = document.createElementNS(
                        "http://www.w3.org/2000/svg",
                        "circle"
                    );
                    circle.setAttribute("cx", x);
                    circle.setAttribute("cy", y);
                    circle.setAttribute("r", 4);
                    circle.setAttribute("fill", value === 0 ? "#e9ecef" : "#667eea");
                    circle.setAttribute("stroke", "white");
                    circle.setAttribute("stroke-width", 2);

                    // Add hover effect
                    circle.addEventListener("mouseenter", () => {
                        circle.setAttribute("r", 6);
                        circle.setAttribute("fill", "#764ba2");
                    });
                    circle.addEventListener("mouseleave", () => {
                        circle.setAttribute("r", 4);
                        circle.setAttribute("fill", value === 0 ? "#e9ecef" : "#667eea");
                    });

                    // Add value tooltip on hover
                    circle.addEventListener("mouseenter", () => {
                        const tooltip = document.createElementNS(
                            "http://www.w3.org/2000/svg",
                            "text"
                        );
                        tooltip.setAttribute("x", x);
                        tooltip.setAttribute("y", y - 15);
                        tooltip.setAttribute("text-anchor", "middle");
                        tooltip.setAttribute("font-size", "12");
                        tooltip.setAttribute("fill", "#495057");
                        tooltip.setAttribute("font-weight", "bold");
                        tooltip.textContent = `${new Date(date).toLocaleDateString(
                "en-US",
                { month: "short", day: "numeric" }
              )}: ${value} questions`;
                        tooltip.id = "tooltip";
                        chartGroup.appendChild(tooltip);
                    });
                    circle.addEventListener("mouseleave", () => {
                        const tooltip = document.getElementById("tooltip");
                        if (tooltip) tooltip.remove();
                    });

                    chartGroup.appendChild(circle);
                });

                // Add gradient definition for the line
                const defs = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "defs"
                );
                const lineGradient = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "linearGradient"
                );
                lineGradient.setAttribute("id", "lineGradient");
                lineGradient.setAttribute("x1", "0%");
                lineGradient.setAttribute("y1", "0%");
                lineGradient.setAttribute("x2", "100%");
                lineGradient.setAttribute("y2", "0%");

                const stop1 = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "stop"
                );
                stop1.setAttribute("offset", "0%");
                stop1.setAttribute("stop-color", "#667eea");

                const stop2 = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "stop"
                );
                stop2.setAttribute("offset", "100%");
                stop2.setAttribute("stop-color", "#764ba2");

                lineGradient.appendChild(stop1);
                lineGradient.appendChild(stop2);
                defs.appendChild(lineGradient);
                svg.appendChild(defs);

                // Add chart elements to group
                chartGroup.appendChild(yAxis);
                chartGroup.appendChild(xAxis);
                chartGroup.appendChild(yAxisLabel);
                chartGroup.appendChild(xAxisLabel);
                chartGroup.appendChild(linePath);

                // Add chart group to SVG
                svg.appendChild(chartGroup);

                container.appendChild(svg);
            }

            createWordCloud(wordCloudData) {
                const container = document.getElementById("wordCloudContainer");
                container.innerHTML = "";

                if (!wordCloudData || wordCloudData.length === 0) {
                    return;
                }

                // Check if d3-cloud is available
                if (
                    typeof d3 === "undefined" ||
                    typeof d3.layout === "undefined" ||
                    typeof d3.layout.cloud === "undefined"
                ) {
                    console.warn("d3-cloud not available");
                    return;
                }

                // Get container dimensions
                const containerWidth = container.clientWidth || 800;
                const containerHeight = container.clientHeight || 500;

                // Find min and max frequencies for scaling
                const frequencies = wordCloudData.map((item) => item.frequency);
                const minFreq = Math.min(...frequencies);
                const maxFreq = Math.max(...frequencies);

                // Use D3's default color scheme
                const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

                // Function to get font size based on frequency
                function getFontSize(frequency) {
                    const minSize = 14;
                    const maxSize = 60;
                    return (
                        minSize +
                        ((frequency - minFreq) / (maxFreq - minFreq)) *
                        (maxSize - minSize)
                    );
                }

                // Generate words array from word cloud data
                const words = wordCloudData.map((item, index) => ({
                    text: item.word,
                    size: getFontSize(item.frequency),
                    frequency: item.frequency,
                    color: colorScale(index),
                }));

                // Create word cloud layout
                const layout = d3.layout
                    .cloud()
                    .size([containerWidth, containerHeight])
                    .words(words)
                    .padding(5)
                    .rotate(() => ~~(Math.random() * 2) * 90)
                    .font("Segoe UI, Tahoma, Geneva, Verdana, sans-serif")
                    .fontSize((d) => d.size)
                    .on("end", draw);

                // Start the layout
                layout.start();

                function draw(words) {
                    // Create SVG and add words
                    d3.select(container)
                        .append("svg")
                        .attr("width", layout.size()[0])
                        .attr("height", layout.size()[1])
                        .append("g")
                        .attr(
                            "transform",
                            "translate(" +
                            layout.size()[0] / 2 +
                            "," +
                            layout.size()[1] / 2 +
                            ")"
                        )
                        .selectAll("text")
                        .data(words)
                        .enter()
                        .append("text")
                        .style("font-size", (d) => d.size + "px")
                        .style(
                            "font-family",
                            "Segoe UI, Tahoma, Geneva, Verdana, sans-serif"
                        )
                        .style("font-weight", "600")
                        .style("fill", (d) => d.color)
                        .attr("text-anchor", "middle")
                        .attr(
                            "transform",
                            (d) => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")"
                        )
                        .text((d) => d.text);
                }
            }

            populateTables(data) {
                this.populateQuestionsTable(data.top_questions);
                this.populateCategoriesTable(data.top_categories);
            }

            populateQuestionsTable(questions) {
                const tbody = document.querySelector("#questionsTable tbody");
                tbody.innerHTML = "";

                questions.forEach((item) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.question}</td>
                        <td><span class="frequency-badge">${item.frequency}</span></td>
                    `;
                });
            }

            populateCategoriesTable(categories) {
                const tbody = document.querySelector("#categoriesTable tbody");
                tbody.innerHTML = "";

                categories.forEach((item) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.category}</td>
                        <td><span class="frequency-badge">${item.frequency}</span></td>
                    `;
                });
            }

            showDashboard() {
                document.getElementById("dashboard").style.display = "block";
            }

            showLoading(show) {
                document.getElementById("loading").style.display = show ?
                    "block" :
                    "none";
                document.getElementById("submitBtn").disabled = show;
            }

            showError(message) {
                this.hideError();
                const errorDiv = document.createElement("div");
                errorDiv.className = "error";
                errorDiv.textContent = message;
                errorDiv.id = "errorMessage";

                const datePicker = document.querySelector(".date-picker");
                datePicker.appendChild(errorDiv);
            }

            hideError() {
                const existingError = document.getElementById("errorMessage");
                if (existingError) {
                    existingError.remove();
                }
            }
        }

        // Initialize the dashboard when the page loads
        document.addEventListener("DOMContentLoaded", () => {
            new AnalyticsDashboard();
        });
    </script>
</body>

</html>